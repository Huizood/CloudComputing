CI/CD workflow using Jenkins and Bitbucket
-------------------------------------------

Use your personal google account for this experiment.

First, pull the latest code from CloudComputing git repo.

cd CloudComputing
git pull origin master

Setup
------
In this experiment, you will setup continuous integration, continuous delivery
using Jenkins. You will configure your BitBucket account with a webhook
to trigger a Jenkins job. The Jenkins job will deploy WordPress helm chart
on your Kubernetes cluster in Google cloud (GKE).

You will need to create your own GKE cluster (steps given below).

You will use hosted Jenkins instance. We will provide the Jenkins URL and login credentials to you.


1) For this assignment, create a new **public** Bitbucket repository named "assignment4"
   - Clone it on your machine
     - git clone https://<your-bitbucket-username>/assignment4.git

2) Setup following files in your assignment4 folder:
   - cp -r CloudComputing/CICD/wp-chart assignment4/.
   - cp CloudComputing/CICD/containerized/build.sh assignment4/.
   - cp CloudComputing/CICD/containerized/deploy.sh assignment4/.
   - cd assignment4
   - git add wp-chart
   - git add build.sh
   - git add deploy.sh
   - git commit
     - enter some commit message
   - git push origin master


3) Install Google Cloud CLI on your machine
   - Follow the instructions from: https://cloud.google.com/sdk/docs/install

4) Configure authentication for gcloud CLI. We need this step to create GKE cluster
   - gcloud auth login --> Follow the prompts (you will have to open browser window and paste the generated link,
       then paste the generated code in the verification field in your console.)
   - Create Project in Google Cloud Console --> Note down the Project ID. Remember that Project ID is different than the Project's Name.
       You will need Project ID in subsequent steps.
   - Set environment variables (Linux/MacOS use export command for this; for windows use set command)
   - export PROJECT_ID=<Project-ID-from-previous-step>
   - export CLOUDSDK_COMPUTE_ZONE=us-central1-b
   - gcloud config set project ${PROJECT_ID}

5) Enable Kubernetes Engine API for your project
   - https://console.cloud.google.com/apis/library/browse?filter=category:compute&project=<your-project-name>

6) Create GKE cluster that will run your WordPress Helm chart
   - ./create-gke-cluster.sh <project-id> <cluster-name>
   - NOTE that capital letters are not allowed in cluster name.

7) Once the cluster is created, you can open traffic to the ports on your cluster VM by following these steps:
   -  Go to VPC Network -> Firewall -> Select the rule that has following name:
      gke-cluster_name-<string of letters+numbers>-all
   -> Hit Edit
   -> In the Source IP ranges, enter: 0.0.0.0/0
   -> Hit Save

8) Create service account in Google Cloud console
   - Select project-id
   - Go to IAM & admin -> Service account
   - Create service account
     -> Enter some name -> create and continue  
        -> Select a role - > Kubernetes Engine Developer
        -> continue -> done
   - Select the three vertical dots on the right in the account row
     -> Manage keys -> Add Key -> Create new key -> Key type json 
   - The Service Account Key file in JSON format will be downloaded to your machine 

9) Setup Jenkins 
   9.1) Login to Jenkins
   9.2) Install the Post build task Plugin and Bitbucket Plugin
        - Bitbucket plugin will be used to clone Bitbucket repo
        - Post build task plugin will be used to perform build and deploy tasks
        Jenkins -> Manage Jenkins -> Manage Plugins
	- In Available tab, search "Post build task" and select
	- In Available tab, search "Bitbucket" and select
	  (Note: There are several Bitbucket plugins -- you want to choose the one whose
           name contains only the word "Bitbucket" and nothing else)
	- Choose Install without restarting option
   9.3) Set up a Jenkins Job 
        9.3.1) Jenkins -> New Item -> Give name -> Select Freestyle project
             -> Source Code Management -> Git -> Give your assignment 4 Bitbucket Repository URL (using https protocol)
             -> Leave Branches to build as empty
        9.3.2) Select "This project is parameterized" -> Choose File Parameter
               -> Choose File Location as "kubeconfig.json"
        9.3.3) Build Triggers
             -> Choose "Build when a change is pushed to BitBucket"
        9.3.4) Buid Section -> Add a build step -> Execute Shell script
             -> In the Execute shell Command section:
                - Add contents of build.sh
        9.3.5) In Post-build Actions
             -> Add post-build action -> Post build task
                -> Log text "SUCCESS" -> Operation "-- OR --"
                   -> In the Tasks -> Script section:
	              - Add contents of deploy.sh 
                      - NOTE: (modify the deploy.sh steps to use your GCP Project ID and your cluster name.
        9.3.6) Save
        9.3.7) *** Manually trigger the Jenkins pipeline ***
               - Build with Parameters
                 - Choose the json file that you downloaded in step 8.
                 - Hit Build
                 - This will upload the file to your Jenkins instance and will be available when
                   you do the CI/CD experiment by triggering builds from BitBucket. 

10) Add a WebHook to your Bitbucket repository

   Go to your Bitbucket repository -> Settings -> Webhooks -> Add webhook
        - <Jenkins-url>/bitbucket-hook/
          (Note: The trailing slash '/' is important. Don't forget that!!)
        - Make Status as "Active"
        - Check "Skip certificate verification"
        - Triggers -> Choose from a full list of triggers
          - Select following: 
            - Repository->Push, Pull Request->Created, Updated, Comment created, Comment updated, Comment deleted
              Issue->Created, Issue->Updated, Issue->Comment Created
         

CI/CD Experiment:
-----------------
1) Open the Jenkins URL in your browser and navigate to the job

2) On your machine make changes to the wp-chart and push the code:
   - Modify something in the YAML file (say, make replicaCount=2)
   - git add
   - git commit
   - git push origin master

3) If your CICD setup has been done properly, you should see a new build triggered (visible under "Build History")
   - Select the Build
   - Go to Console Output
   - Verify that the build and deploy steps have been executed

4) On your Kubernetes cluster, check if the WordPress stack has been deployed or not
   - From your machine run
     - kubectl get pods -A
     - Get the ExternalIP of the VM of your cluster
       -> Google Cloud Console -> Compute Engine -> VM Instances
     - curl -v https://<External IP>:30005/
     - Open in browser: https://<External IP>:30005

5) Repeat steps 2-3-4 with different changes



Clean up:
---------
From Google Cloud Console:
- Delete Kubernetes Cluster


Troubleshooting:
----------------



Reference:
-----------
